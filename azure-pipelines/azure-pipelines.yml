trigger:
  - main
  - develop

pr:
  - main
  - develop

pool:
  vmImage: 'ubuntu-latest'

variables:
  dockerImageName: 'dvna'
  dockerImageTag: '$(Build.BuildId)'
  dockerLatestTag: 'latest'
  sonarHostUrl: 'https://sonarqube.example.com'
  snykOrgId: 'org-id'
  nodeVersion: '14.x'

stages:
  # ============================================
  # SETUP STAGE
  # ============================================
  
  - stage: Setup
    displayName: 'Setup & Dependencies'
    jobs:
      - job: InstallDependencies
        displayName: 'Install NPM Dependencies'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: $(nodeVersion)
            displayName: 'Install Node.js'
          
          - task: Cache@2
            inputs:
              key: 'npm | "$(Agent.OS)" | package-lock.json'
              restoreKeys: |
                npm | "$(Agent.OS)"
              path: $(npm_config_cache)
            displayName: 'Cache npm packages'
          
          - script: npm install
            displayName: 'Install Dependencies'
          
          - publish: $(System.DefaultWorkingDirectory)
            artifact: 'repo-with-deps'
            displayName: 'Publish repo with dependencies'

  # ============================================
  # SECURITY SCANNING STAGES
  # ============================================
  
  - stage: SAST
    displayName: 'SAST Scanning'
    dependsOn: Setup
    jobs:
      - job: Semgrep
        displayName: 'Semgrep SAST Scan'
        steps:
          - download: current
            artifact: 'repo-with-deps'
            displayName: 'Download repo with dependencies'
          
          - script: |
              docker run --rm -v $(System.DefaultWorkingDirectory):/app returntocorp/semgrep \
                semgrep --config=p/security-audit --config=p/owasp-top-ten --json -o /app/semgrep-report.json /app . || true
              docker run --rm -v $(System.DefaultWorkingDirectory):/app returntocorp/semgrep \
                semgrep --config=p/security-audit --config=p/owasp-top-ten --text /app . || true
            displayName: 'Run Semgrep'
          
          - publish: $(System.DefaultWorkingDirectory)/semgrep-report.json
            artifact: 'semgrep-report'
            displayName: 'Publish Semgrep Report'
            condition: always()

      - job: SonarQube
        displayName: 'SonarQube SAST Scan'
        condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))
        steps:
          - download: current
            artifact: 'repo-with-deps'
            displayName: 'Download repo with dependencies'
          
          - script: |
              npm install -g sonar-scanner
              sonar-scanner \
                -Dsonar.projectKey=dvna \
                -Dsonar.projectName=DVNA \
                -Dsonar.sources=. \
                -Dsonar.exclusions=node_modules/**,docs/**,public/** \
                -Dsonar.host.url=$(SONAR_HOST_URL) \
                -Dsonar.login=$(SONAR_TOKEN)
            displayName: 'Run SonarQube Scan'
            condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))

  - stage: SCA
    displayName: 'SCA Scanning'
    dependsOn: Setup
    jobs:
      - job: NPMAudit
        displayName: 'NPM Audit'
        steps:
          - download: current
            artifact: 'repo-with-deps'
            displayName: 'Download repo with dependencies'
          
          - script: |
              npm audit --json > npm-audit-report.json || true
              npm audit --audit-level=moderate || true
            displayName: 'Run npm audit'
          
          - publish: $(System.DefaultWorkingDirectory)/npm-audit-report.json
            artifact: 'npm-audit-report'
            displayName: 'Publish npm audit Report'
            condition: always()

      - job: Snyk
        displayName: 'Snyk Scan'
        condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))
        steps:
          - download: current
            artifact: 'repo-with-deps'
            displayName: 'Download repo with dependencies'
          
          - script: |
              docker run --rm \
                -e SNYK_TOKEN=$(SNYK_TOKEN) \
                -v $(System.DefaultWorkingDirectory):/app \
                snyk/snyk:node-14 \
                snyk test --severity-threshold=high --json-file-output=/app/snyk-report.json || true
            displayName: 'Run Snyk'
          
          - publish: $(System.DefaultWorkingDirectory)/snyk-report.json
            artifact: 'snyk-report'
            displayName: 'Publish Snyk Report'
            condition: always()

      - job: TrivyFS
        displayName: 'Trivy Filesystem Scan'
        steps:
          - download: current
            artifact: 'repo-with-deps'
            displayName: 'Download repo with dependencies'
          
          - script: |
              docker run --rm -v $(System.DefaultWorkingDirectory):/app aquasec/trivy:latest \
                fs --format json --output /app/trivy-fs-report.json /app || true
              docker run --rm -v $(System.DefaultWorkingDirectory):/app aquasec/trivy:latest \
                fs --severity HIGH,CRITICAL /app || true
            displayName: 'Run Trivy Filesystem Scan'
          
          - publish: $(System.DefaultWorkingDirectory)/trivy-fs-report.json
            artifact: 'trivy-fs-report'
            displayName: 'Publish Trivy FS Report'
            condition: always()

  # ============================================
  # TEST STAGE
  # ============================================
  
  - stage: Test
    displayName: 'Unit Tests'
    dependsOn: Setup
    jobs:
      - job: UnitTests
        displayName: 'Run Unit Tests'
        steps:
          - download: current
            artifact: 'repo-with-deps'
            displayName: 'Download repo with dependencies'
          
          - task: NodeTool@0
            inputs:
              versionSpec: $(nodeVersion)
            displayName: 'Install Node.js'
          
          - script: npm test 2>&1 || true
            displayName: 'Run Tests'
          
          - task: PublishTestResults@2
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/test-results/**/*.xml'
              searchFolder: '$(System.DefaultWorkingDirectory)'
              failTaskOnFailedTests: false
            displayName: 'Publish Test Results'
            condition: always()
          
          - publish: $(System.DefaultWorkingDirectory)/coverage
            artifact: 'coverage-report'
            displayName: 'Publish Coverage Report'
            condition: always()

  # ============================================
  # BUILD STAGE
  # ============================================
  
  - stage: Build
    displayName: 'Build Docker Image'
    dependsOn: 
      - SAST
      - SCA
      - Test
    condition: succeeded()
    jobs:
      - job: BuildDockerImage
        displayName: 'Build & Scan Docker Image'
        steps:
          - download: current
            artifact: 'repo-with-deps'
            displayName: 'Download repo with dependencies'
          
          - task: Docker@2
            inputs:
              command: 'build'
              Dockerfile: '$(System.DefaultWorkingDirectory)/Dockerfile'
              tags: |
                $(DOCKER_REGISTRY)/$(dockerImageName):$(dockerImageTag)
                $(DOCKER_REGISTRY)/$(dockerImageName):$(dockerLatestTag)
            displayName: 'Build Docker Image'
            condition: succeeded()
          
          - script: |
              echo "Image built successfully:"
              echo "$(DOCKER_REGISTRY)/$(dockerImageName):$(dockerImageTag)"
              echo "$(DOCKER_REGISTRY)/$(dockerImageName):$(dockerLatestTag)"
            displayName: 'Log Image Tags'

      - job: TrivyImageScan
        displayName: 'Trivy Image Scan'
        dependsOn: BuildDockerImage
        steps:
          - script: |
              docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy:latest \
                image --severity HIGH,CRITICAL --exit-code 0 $(DOCKER_REGISTRY)/$(dockerImageName):$(dockerImageTag) || true
              docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy:latest \
                image --format json --output trivy-image-report.json $(DOCKER_REGISTRY)/$(dockerImageName):$(dockerImageTag)
            displayName: 'Run Trivy Image Scan'
          
          - publish: $(System.DefaultWorkingDirectory)/trivy-image-report.json
            artifact: 'trivy-image-report'
            displayName: 'Publish Trivy Image Report'
            condition: always()

      - job: GrypeScan
        displayName: 'Grype Image Scan'
        dependsOn: BuildDockerImage
        steps:
          - script: |
              curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin
              grype $(DOCKER_REGISTRY)/$(dockerImageName):$(dockerImageTag) --output json > grype-report.json || true
              grype $(DOCKER_REGISTRY)/$(dockerImageName):$(dockerImageTag) --fail-on high || true
            displayName: 'Run Grype Scan'
          
          - publish: $(System.DefaultWorkingDirectory)/grype-report.json
            artifact: 'grype-report'
            displayName: 'Publish Grype Report'
            condition: always()

      - job: PushImage
        displayName: 'Push Docker Image'
        dependsOn: 
          - TrivyImageScan
          - GrypeScan
        condition: and(succeeded(), or(eq(variables['Build.SourceBranch'], 'refs/heads/main'), eq(variables['Build.SourceBranch'], 'refs/heads/develop')))
        steps:
          - task: Docker@2
            inputs:
              command: 'login'
              containerRegistry: '$(DOCKER_REGISTRY_CONNECTION)'
            displayName: 'Login to Docker Registry'
          
          - task: Docker@2
            inputs:
              command: 'push'
              repository: '$(DOCKER_REGISTRY)/$(dockerImageName)'
              tags: |
                $(dockerImageTag)
                $(dockerLatestTag)
            displayName: 'Push Docker Image'

  # ============================================
  # DEPLOYMENT STAGES
  # ============================================
  
  - stage: DeployStaging
    displayName: 'Deploy to Staging'
    dependsOn: Build
    condition: and(succeeded(), or(eq(variables['Build.SourceBranch'], 'refs/heads/main'), eq(variables['Build.SourceBranch'], 'refs/heads/develop')))
    jobs:
      - deployment: DeployApp
        displayName: 'Deploy DVNA to Staging'
        environment: 'staging'
        strategy:
          runOnce:
            deploy:
              steps:
                - script: |
                    echo "Deploying DVNA to staging environment..."
                    echo "Image: $(DOCKER_REGISTRY)/$(dockerImageName):$(dockerImageTag)"
                    echo "Deployment URL: https://dvna-staging.example.com"
                  displayName: 'Deploy Application'
                
                - script: |
                    echo "Verifying deployment..."
                    # Add your deployment verification commands here
                  displayName: 'Verify Deployment'

  - stage: DeployProduction
    displayName: 'Deploy to Production'
    dependsOn: DeployStaging
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: ApproveAndDeploy
        displayName: 'Approve and Deploy to Production'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - script: |
                    echo "Deploying DVNA to production environment..."
                    echo "Image: $(DOCKER_REGISTRY)/$(dockerImageName):$(dockerImageTag)"
                    echo "Deployment URL: https://dvna.example.com"
                  displayName: 'Deploy Application'
                
                - script: |
                    echo "Verifying production deployment..."
                    # Add your production verification commands here
                  displayName: 'Verify Deployment'

  # ============================================
  # REPORTING STAGE
  # ============================================
  
  - stage: Reports
    displayName: 'Generate & Archive Reports'
    dependsOn: 
      - SAST
      - SCA
      - Test
      - Build
    condition: always()
    jobs:
      - job: PublishReports
        displayName: 'Archive All Reports'
        steps:
          - download: current
            artifact: 'repo-with-deps'
            displayName: 'Download repo'
          
          - download: current
            artifact: 'semgrep-report'
            displayName: 'Download Semgrep Report'
            condition: always()
          
          - download: current
            artifact: 'npm-audit-report'
            displayName: 'Download npm audit Report'
            condition: always()
          
          - download: current
            artifact: 'snyk-report'
            displayName: 'Download Snyk Report'
            condition: always()
          
          - download: current
            artifact: 'trivy-fs-report'
            displayName: 'Download Trivy FS Report'
            condition: always()
          
          - download: current
            artifact: 'coverage-report'
            displayName: 'Download Coverage Report'
            condition: always()
          
          - download: current
            artifact: 'trivy-image-report'
            displayName: 'Download Trivy Image Report'
            condition: always()
          
          - download: current
            artifact: 'grype-report'
            displayName: 'Download Grype Report'
            condition: always()
          
          - script: |
              mkdir -p $(Build.ArtifactStagingDirectory)/scan-reports
              find $(Pipeline.Workspace) -name "*-report*" -type f -exec cp {} $(Build.ArtifactStagingDirectory)/scan-reports/ \; || true
              find $(Pipeline.Workspace) -path "*/coverage/*" -type f -exec cp {} $(Build.ArtifactStagingDirectory)/scan-reports/ \; || true
            displayName: 'Gather Reports'
          
          - publish: $(Build.ArtifactStagingDirectory)/scan-reports
            artifact: 'all-reports'
            displayName: 'Publish All Reports'
            condition: always()
          
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)'
              ArtifactName: 'build-artifacts'
              publishLocation: 'Container'
            displayName: 'Publish Build Artifacts'
            condition: always()
